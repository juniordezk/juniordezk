const TelegramBot = require("node-telegram-bot-api");
const express = require("express");
const moment = require("moment-timezone");

const token = "8484705394:AAFz4jQ7dmxhxxoVmRZcv0wqqBWVu2udPHk";
const chatId = "-1003073731528";

const bot = new TelegramBot(token, { polling: false });
const app = express();

// Configura√ß√µes de sinais
const MIN_SIGNAL = 3; // minutos entre sinais
const MAX_SIGNAL = 6;
const MIN_SIGNALS_LIST = 15;
const MAX_SIGNALS_LIST = 20;
const MAX_RED_PER_LIST = 2;

// Controle di√°rio
let diaAtual = moment().tz("America/Sao_Paulo").date();

// Fun√ß√£o auxiliar
function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Gera lista de sinais para a hora atual
function gerarListaSinais() {
  const quantidade = randomInt(MIN_SIGNALS_LIST, MAX_SIGNALS_LIST);
  const lista = [];
  let minuto = 0;

  for (let i = 0; i < quantidade; i++) {
    const cor = Math.random() < 0.5 ? "PLAYER üîµ" : "BANKER üî¥";
    const delta = randomInt(MIN_SIGNAL, MAX_SIGNAL);
    minuto += delta;

    const now = moment().tz("America/Sao_Paulo");
    let hora = now.hour();
    let m = minuto;
    if (m >= 60) {
      hora += Math.floor(m / 60);
      m = m % 60;
    }
    if (hora >= 24) hora = hora % 24;

    const horaStr = hora.toString().padStart(2, "0");
    const minStr = m.toString().padStart(2, "0");
    lista.push({ horario: ${horaStr}:${minStr}, cor });
  }

  return lista;
}

// Envia lista inicial
async function enviarLista(lista) {
  let texto = "üìä Lista gerada com sucesso\n";
  const now = moment().tz("America/Sao_Paulo");
  texto += üïí Hor√°rio: ${now.format("HH:mm")}\n\n;
  lista.forEach(sinal => {
    texto += ${sinal.horario} - ${sinal.cor}\n;
  });
  await bot.sendMessage(chatId, texto, { parse_mode: "Markdown" });
}

// Programa sinais e relat√≥rio
async function programarSinais(lista) {
  const now = moment().tz("America/Sao_Paulo");

  // Envia cada sinal no hor√°rio certo
  lista.forEach(sinal => {
    const [h, m] = sinal.horario.split(":").map(Number);
    const sinalTime = moment.tz({ hour: h, minute: m }, "America/Sao_Paulo");
    const delay = sinalTime.diff(now, "milliseconds");

    if (delay > 0) {
      setTimeout(() => {
        bot.sendMessage(chatId, **Cor esperada para agora:** ${sinal.cor}, { parse_mode: "Markdown" });
      }, delay);
    }
  });

  // Relat√≥rio 2 min ap√≥s √∫ltimo sinal
  const last = lista[lista.length - 1];
  const [lh, lm] = last.horario.split(":").map(Number);
  const lastTime = moment.tz({ hour: lh, minute: lm }, "America/Sao_Paulo").add(2, "minutes");
  const delayRelatorio = lastTime.diff(moment().tz("America/Sao_Paulo"), "milliseconds");

  setTimeout(() => {
    // Sorteia 0‚Äì2 perdas
    const lossCount = randomInt(0, MAX_RED_PER_LIST);
    const lossIndexes = [];
    while (lossIndexes.length < lossCount) {
      const idx = randomInt(0, lista.length - 1);
      if (!lossIndexes.includes(idx)) lossIndexes.push(idx);
    }

    let relatorioüèÅ SESS√ÉO FINALIZADADA**\n\n";
    let wins = 0;
    let losses = 0;

    lista.forEach((sinal, index) => {
      if (lossIndexes.includes(index)) {
        relatorio += ${sinal.horario} ${sinal.cor} - LOSS‚õîÔ∏è\n;
        losses++;
      } else {
        relatorio += ${sinal.horario} ${sinal.cor} - WIN‚úÖ\n;
        wins++;
      }
    });

    const total = wins + losses;
    const assertividade = ((wins / total) * 100).toFixed(0);

    relatorio += \nüìä PLACAR: ‚úÖ${wins} ‚õîÔ∏è${losses}\n;
    relatorio += üöÄ ${assertividade}% de assertividade;

    bot.sendMessage(chatId, relatorio, { parse_mode: "Markdown" });
  }, delayRelatorio);
}

// Loop principal
function loopHorario() {
  const now = moment().tz("America/Sao_Paulo");

  // Reset di√°rio √†s 00:00
  if (now.date() !== diaAtual) {
    diaAtual = now.date();
    console.log("üîÑ Novo dia, placar zerado.");
  }

  const lista = gerarListaSinais();
  enviarLista(lista);
  programarSinais(lista);

  // Pr√≥ximo loop na pr√≥xima hora cheia
  const proximaHora = now.clone().add(1, "hour").startOf("hour");
  const delay = proximaHora.diff(now, "milliseconds");
  setTimeout(loopHorario, delay);
}

// Start
loopHorario();

// Servidor web Render
app.get("/", (req, res) => res.send("Bot de sinais 24h rodando no Render üöÄ"));
app.listen(3000, () => console.log("Servidor ativo na porta 3000."));

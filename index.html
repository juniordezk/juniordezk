<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Studio - Estat√≠sticas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        home: '#ef4444',
                        away: '#3b82f6',
                        draw: '#facc15'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-emerald-800 to-emerald-900 text-white">
    <div class="max-w-screen-lg mx-auto px-4 py-6">

        <h1 class="text-4xl font-extrabold text-center text-white mb-6">üìä Central Football Studio</h1>


        <section class="mb-8 border border-slate-700 rounded-xl p-4 bg-slate-800/50 shadow-md">
            <h2 class="text-2xl font-bold mb-4">üîç Ponto de Aten√ß√£o</h2>
            <div id="sinais-entrada" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>
        <div class="px-2 sm:px-4 my-4">
            <iframe src="https://start.bet.br/signup?btag=CX-48607_441984_FS&brand=FS&withRedirect=%2Flive-casino%2Fgame%2F1309373%3Fprovider%3DEvolution%26from%3D%252Flive-casino%253FproviderNames%253DEvolution%2526name%253Dfootball&path=loginMultichannel" width="100%"
                height="600" class="rounded-lg shadow-lg border-none" loading="lazy" allowfullscreen>
  </iframe>
        </div>
        <section class="mb-8 border border-slate-700 rounded-xl p-4 bg-slate-800/50 shadow-md">
            <h2 class="text-2xl font-bold mb-4">üïπÔ∏è Resultados do Baralho Atual</h2>
            <div id="linha-tempo" class="flex flex-wrap gap-1 mb-4"></div>
            <div id="linha-legenda" class="flex gap-4 text-sm text-gray-300"></div>
        </section>

        <section id="empate-alerta" class="mb-8"></section>


        <section class="mb-8 border border-slate-700 rounded-xl p-4 bg-slate-800/50 shadow-md">
            <h2 class="text-2xl font-bold mb-4"> √öltimos Baralhos</h2>
            <div id="historico-baralhos" class="grid gap-4 sm:grid-cols-2 md:grid-cols-3"></div>
        </section>

        <section class="mb-8 border border-slate-700 rounded-xl p-4 bg-slate-800/50 shadow-md">
            <h2 class="text-2xl font-bold mb-4">Distribui√ß√£o por Hora do Dia</h2>
            <p class="text-gray-400 mb-2">Em cada hora do dia, quantos % cada resultado</p>
            <canvas id="graficoHora" height="200"></canvas>
        </section>

        <section id="historico-resultados" class="mt-10 px-2"></section>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let graficoHora = null;


        function carregarStreaks() {
            fetch('inc/streaks.php')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('streaks-list');
                    container.innerHTML = data.map(s => {
                        const label = s.tipo === 'H' ? 'Home' : s.tipo === 'A' ? 'Away' : 'Empate';
                        const color = s.tipo === 'H' ? 'bg-red-600' : s.tipo === 'A' ? 'bg-blue-600' : 'bg-slate-600';
                        return `
          <div class="${color} text-white p-6 rounded-xl text-center shadow-lg">
              <div class="text-2xl font-bold">${label}</div>
              <div class="text-4xl mt-2 font-extrabold">${s.quantidade}</div>
          </div>
        `;
                    }).join('');
                });
        }

        function carregarEmpateAtrasado() {
            fetch('inc/empate_atrasado.php')
                .then(res => res.json())
                .then(data => {
                    const el = document.getElementById('empate-alerta');
                    const diff = data.jogos_desde_ultimo;
                    const media = data.media_intervalo;

                    let status = '‚ö™ Empate dentro da m√©dia';
                    let boxClass = 'bg-slate-800 text-white';

                    if (diff <= Math.max(1, media * 0.5)) {
                        status = ' Empate recente';
                        boxClass = 'bg-green-700 text-white';
                    } else if (diff > media * 1.5) {
                        status = 'Ô∏è Empate atrasado';
                        boxClass = 'bg-yellow-600 text-black';
                    }

                    const intervalosHTML = data.ultimos_intervalos.map(v => `
        <div class="bg-black/20 px-3 py-1 rounded-md font-bold">${v}</div>
      `).join('');

                    // Nova se√ß√£o: estat√≠stica do que acontece ap√≥s empate
                    let estatisticaHTML = '';
                    if (data.pos_empate_proximo) {
                        const {
                            H = 0, A = 0, D = 0
                        } = data.pos_empate_proximo;
                        estatisticaHTML = `
          <div class="mt-6 bg-slate-700 p-4 rounded-xl">
            <h3 class="text-lg font-semibold mb-2"> Empate puxou:</h3>
            <div class="flex gap-4 justify-center text-lg font-bold">
              <div>üî¥ ${H}%</div>
              <div>üü° ${D}%</div>
              <div>üîµ ${A}%</div>
            </div>
          </div>
        `;
                    }

                    el.innerHTML = `
        <div class="${boxClass} p-6 rounded-xl text-center shadow-lg">
          <h2 class="text-2xl font-bold mb-2">${status}</h2>
          <p>M√©dia entre empates: <strong>${media}</strong></p>
          <p>Rodadas desde o √∫ltimo empate: <strong>${diff}</strong></p>
          <p>√öltimo empate: <strong>${data.ultima_empate}</strong></p>
          <div class="mt-4">
            <p class="font-semibold mb-2">Intervalos anteriores:</p>
            <div class="flex flex-wrap justify-center gap-2">
              ${intervalosHTML}
            </div>
          </div>
          ${estatisticaHTML}
        </div>
      `;
                });
        }

        function carregarSinais() {
            fetch('inc/sinais.php')
                .then(res => res.json())
                .then(data => {
                    const el = document.getElementById('sinais-entrada');
                    const sinais = data.sinais || []; //  acessar a chave correta

                    if (sinais.length === 0) {
                        el.innerHTML = `<div class="bg-slate-700 p-4 rounded text-center">Nenhum no momento.</div>`;
                        return;
                    }

                    el.innerHTML = sinais.map(s => `
        <div class="bg-amber-500 text-black p-4 rounded-xl shadow-lg font-semibold">
          ${s.mensagem}
        </div>
      `).join('');
                });
        }

        function carregarGraficoHora() {
            fetch('inc/por_hora.php')
                .then(res => res.json())
                .then(data => {
                    const labels = Object.keys(data).map(h => `${h}h`);
                    const valoresH = Object.values(data).map(v => v.H);
                    const valoresA = Object.values(data).map(v => v.A);
                    const valoresD = Object.values(data).map(v => v.D);

                    const ctx = document.getElementById('graficoHora').getContext('2d');

                    if (graficoHora) {
                        graficoHora.data.labels = labels;
                        graficoHora.data.datasets[0].data = valoresH;
                        graficoHora.data.datasets[1].data = valoresA;
                        graficoHora.data.datasets[2].data = valoresD;
                        graficoHora.update();
                    } else {
                        graficoHora = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels,
                                datasets: [{
                                        label: 'Home',
                                        data: valoresH,
                                        backgroundColor: 'rgba(239,68,68,0.7)' // vermelho
                                    },
                                    {
                                        label: 'Away',
                                        data: valoresA,
                                        backgroundColor: 'rgba(59,130,246,0.7)' // azul
                                    },
                                    {
                                        label: 'Draw',
                                        data: valoresD,
                                        backgroundColor: '#FFD700' // cinza
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: {
                                        stacked: true
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true
                                    }
                                },
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                });
        }


        function carregarLinhaTempo() {
            fetch('inc/ultimos_resultados.php')
                .then(res => res.json())
                .then(data => {
                    if (data.erro) return;

                    const el = document.getElementById('linha-tempo');
                    el.innerHTML = data.resultados.map(r => {
                        const cor = r === 'H' ? 'bg-red-600' : r === 'A' ? 'bg-blue-600' : 'bg-yellow-400';
                        const tooltip = r === 'H' ? 'Home' : r === 'A' ? 'Away' : 'Empate';
                        return `<div title="${tooltip}" class="${cor} w-3 h-3 rounded-full"></div>`;
                    }).join('');

                    const legenda = document.getElementById('linha-legenda');
                    legenda.innerHTML = `
        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-600"></div> Home: ${data.porcentagens.H}%</div>
        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-600"></div> Away: ${data.porcentagens.A}%</div>
        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-400"></div> Empate: ${data.porcentagens.D}%</div>
      `;
                });
        }

        function carregarHistoricoShoes() {
            fetch('inc/historico_shoes.php', {
                    cache: 'no-store'
                })
                .then(async (res) => {
                    if (!res.ok) {
                        const text = await res.text(); // captura HTML/JSON de erro
                        throw new Error(`HTTP ${res.status} - ${text}`);
                    }
                    // pode vir JSON inv√°lido
                    try {
                        return await res.json();
                    } catch (e) {
                        const text = await res.text();
                        throw new Error(`Resposta n√£o √© JSON. Body: ${text}`);
                    }
                })
                .then((data) => {
                    const container = document.getElementById('historico-baralhos');

                    if (!Array.isArray(data)) {
                        throw new Error('Resposta n√£o √© um array.');
                    }

                    container.innerHTML = data.map((s) => {
                        const bolinhas = (s.resultados || []).map((r) => {
                            const cor =
                                r === 'H' ? 'bg-red-600' :
                                r === 'A' ? 'bg-blue-600' :
                                'bg-yellow-400';
                            return `<div class="${cor} w-2 h-2 rounded-full"></div>`;
                        }).join('');

                        // porcentagens: H (Home/red), A (Away/blue), D (Draw/yellow)
                        const p = s.porcentagens || {
                            H: 0,
                            A: 0,
                            D: 0
                        };

                        return `
          <div class="bg-slate-800 p-4 rounded-xl shadow text-white">
            <p class="text-sm text-gray-400 mb-2"> Baralho #${s.shoe_id ?? '-'}</p>
            <p class="text-xs text-gray-300 mb-2">‚è∞ ${s.inicio ?? '--:--'} ‚Äì ${s.fim ?? '--:--'}</p>
            <div class="flex flex-wrap gap-1 mb-2">${bolinhas}</div>
            <div class="text-xs flex gap-4">
              <span>üî¥ ${p.H}%</span>
              <span>üîµ ${p.A}%</span>
              <span>üü° ${p.D}%</span>
            </div>
          </div>
        `;
                    }).join('');
                })
                .catch((err) => {
                    console.error('historico_shoes:', err);
                    const container = document.getElementById('historico-baralhos');
                    if (container) {
                        container.innerHTML = `
          <div class="bg-red-900/40 border border-red-700 text-red-200 p-3 rounded">
            Falha ao carregar hist√≥rico. <span class="text-xs opacity-80">${String(err).slice(0,200)}</span>
          </div>`;
                    }
                });
        }

        function carregarHistoricoResultados() {
            fetch('inc/historico.php')
                .then(res => res.json())
                .then(data => {
                    const html = `
        <h2 class="text-2xl font-bold mb-4">üåê Hist√≥rico de Resultados</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-slate-800 text-white text-sm rounded-xl overflow-hidden">
            <thead class="bg-slate-700 text-left">
              <tr>
                <th class="px-4 py-2">Hor√°rio</th>
                <th class="px-4 py-2">Home</th>
                <th class="px-4 py-2">Away</th>
                <th class="px-4 py-2">Resultado</th>
              </tr>
            </thead>
            <tbody>
              ${
                data.map(r => {
                  if (r.troca_de_baralho) {
                    const hora = new Date(r.horario).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    return ` <
                        tr class = "bg-yellow-800 text-yellow-300 text-center font-semibold" >
                        <
                        td colspan = "4"
                    class = "py-2" > üîÅTroca de baralho($ {
                            hora
                        }) < /td> <
                        /tr>
                    `;
                  }

                  const label = r.resultado === 'H' ? 'Home' : r.resultado === 'A' ? 'Away' : 'Empate';
                  const cor = r.resultado === 'H' ? 'text-red-400' : r.resultado === 'A' ? 'text-blue-400' : 'text-yellow-400';
                  const dataFormatada = new Date(r.horario).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                  return ` <
                    tr class = "border-b border-gray-600" >
                        <
                        td class = "px-4 py-1 text-gray-300" > $ {
                            dataFormatada
                        } < /td> <
                        td class = "px-4 py-1" > $ {
                            r.home
                        } < /td> <
                        td class = "px-4 py-1" > $ {
                            r.away
                        } < /td> <
                        td class = "px-4 py-1 font-bold ${cor}" > $ {
                            label
                        } < /td> <
                        /tr>
                    `;
                }).join('')
              }
            </tbody>
          </table>
        </div>
      `;

                    const existente = document.getElementById('historico-resultados');
                    if (existente) {
                        existente.innerHTML = html;
                    } else {
                        const container = document.createElement('div');
                        container.className = "mt-10 px-2";
                        container.id = "historico-resultados";
                        container.innerHTML = html;
                        document.body.appendChild(container);
                    }
                });
        }





        // Executa imediatamente ao carregar

        //carregarStreaks();
        carregarEmpateAtrasado();
        carregarSinais();
        carregarGraficoHora();
        carregarLinhaTempo();
        carregarHistoricoShoes();
        carregarHistoricoResultados();

        // Atualiza a cada 5 segundos
        setInterval(() => {

            //carregarStreaks();
            carregarEmpateAtrasado();
            carregarSinais();
            carregarGraficoHora(); // Opcional ‚Äî comente se for muito pesado
            carregarLinhaTempo();
            carregarHistoricoShoes();
            carregarHistoricoResultados();

        }, 5000);
    </script>
    </div>

</body>

</html>